<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevHub</title>
   <link rel="stylesheet" href="style.css">
   <script src="app.js"></script>
</head>
<body>
    <!-- Barra superior -->
    <nav class="navbar">
        <div class="logo">DevHub</div>
        <ul class="menu">
            <li><a href="#" onclick="logout()">Sair</a></li>
            <li><a href="#" onclick="mostrarPerfil()">Perfil</a></li>
            <li><a href="#" onclick="mostrarNotificacoes()">Notifica√ß√µes <span id="notifBadge" class="badge" style="display:none;"></span></a></li>
            <li><a href="#" onclick="deleteUser()">Deletar conta</a></li>
        </ul>
    </nav>

    <!-- Container geral -->
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <img id="fotoPerfil" src="https://via.placeholder.com/100" alt="Foto de perfil">
            <div style="margin-top:10px;">
                <input type="file" id="uploadFoto" accept="image/*" style="width:100%;">
            </div>
            <h2 id="nomeUsuario">Carregando...</h2>
            <p><strong>Idade:</strong> 22 anos</p>
            <p><strong>Profiss√£o:</strong> Estudante de TI</p>
            <p><strong>Local:</strong> Recife - PE</p>
            <button class="btn" id="btnEditarPerfil">Editar Perfil</button>
            <div style="margin-top:10px;">
                <button class="btn" id="btnResetFoto" style="background:#e84118;">Resetar Foto</button>
            </div>
        </aside>

        <!-- Feed principal -->
        <main class="feed">
            <div class="novo-post">
                <button id="novaPostagemBtn">+ Criar Nova Postagem</button>
            </div>

            <!-- Formul√°rio nova postagem -->
            <div id="formNovaPostagem" class="form-postagem oculto">
                <textarea id="textoPost" placeholder="O que deseja compartilhar?"></textarea>
                <button id="enviarPost">Publicar</button>
            </div>

            <!-- Posts ser√£o carregados dinamicamente do banco de dados -->
        </main>

        <!-- Barra direita -->
        <aside class="rightbar">
            <h3>Atividades Recentes</h3>
            <ul>
                <li>Maria comentou em sua postagem</li>
                <li>Lucas curtiu seu perfil</li>
                <li>Voc√™ ganhou 3 novos seguidores</li>
            </ul>
        </aside>
    </div>

    <!-- Modal de Notifica√ß√µes -->
    <div id="modalNotificacoes" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalNotificacoes')">&times;</span>
            <h2>Notifica√ß√µes</h2>
            <div id="listaNotificacoes"></div>
        </div>
    </div>

    <!-- Modal de Perfil -->
    <div id="modalPerfil" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalPerfil')">&times;</span>
            <h2>Perfil</h2>
            <div id="perfilContent">
                <h3>Seguidores</h3>
                <div id="listaSeguidores"></div>
                <h3>Seguindo</h3>
                <div id="listaSeguindo"></div>
            </div>
        </div>
    </div>

    <script>
        // ---------- VERIFICA√á√ÉO DE AUTENTICA√á√ÉO ----------
        const usuarioLogado = JSON.parse(localStorage.getItem('usuario') || 'null');
        
        if (!usuarioLogado) {
            window.location.href = '/login';
        }

        // ---------- FUN√á√ÉO DE LOGOUT ----------
        function logout() {
            localStorage.removeItem('usuario');
            window.location.href = '/login';
        }

        // ---------- FUN√á√ïES DE MODAL ----------
        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ---------- FUN√á√ïES DE NOTIFICA√á√ïES ----------
        async function mostrarNotificacoes() {
            try {
                const response = await fetch(`/notificacoes/${usuarioLogado.id}`);
                if (response.ok) {
                    const notificacoes = await response.json();
                    const lista = document.getElementById('listaNotificacoes');
                    
                    if (notificacoes.length === 0) {
                        lista.innerHTML = '<p>Nenhuma notifica√ß√£o</p>';
                    } else {
                        lista.innerHTML = notificacoes.map(notif => `
                            <div class="notificacao ${notif.lida ? '' : 'nao-lida'}" onclick="marcarComoLida(${notif.id})">
                                <div class="notificacao-tipo">${notif.tipo}</div>
                                <div>${notif.texto}</div>
                                <div style="font-size: 0.8em; color: #999; margin-top: 5px;">
                                    ${new Date(notif.created_at).toLocaleString()}
                                </div>
                            </div>
                        `).join('');
                    }
                    
                    document.getElementById('modalNotificacoes').style.display = 'block';
                    atualizarBadgeNotificacoes();
                }
            } catch (error) {
                console.error('Erro ao carregar notifica√ß√µes:', error);
            }
        }

        async function marcarComoLida(id) {
            try {
                await fetch(`/notificacoes/${id}/lida`, { method: 'PUT' });
                atualizarBadgeNotificacoes();
            } catch (error) {
                console.error('Erro ao marcar notifica√ß√£o como lida:', error);
            }
        }

        async function atualizarBadgeNotificacoes() {
            try {
                const response = await fetch(`/notificacoes/${usuarioLogado.id}`);
                if (response.ok) {
                    const notificacoes = await response.json();
                    const naoLidas = notificacoes.filter(n => !n.lida).length;
                    const badge = document.getElementById('notifBadge');
                    
                    if (naoLidas > 0) {
                        badge.textContent = naoLidas;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Erro ao atualizar badge:', error);
            }
        }

        // ---------- FUN√á√ïES DE PERFIL E SEGUIDORES ----------
        async function mostrarPerfil() {
            try {
                const [seguidoresRes, seguindoRes] = await Promise.all([
                    fetch(`/seguidores/${usuarioLogado.id}`),
                    fetch(`/seguindo/${usuarioLogado.id}`)
                ]);
                
                if (seguidoresRes.ok && seguindoRes.ok) {
                    const seguidores = await seguidoresRes.json();
                    const seguindo = await seguindoRes.json();
                    
                    document.getElementById('listaSeguidores').innerHTML = 
                        seguidores.map(s => `
                            <div class="usuario-item">
                                <span>${s.nome}</span>
                                <button class="btn-seguir" onclick="seguirUsuario(${s.id_seguidor})">
                                    Ver Perfil
                                </button>
                            </div>
                        `).join('');
                    
                    document.getElementById('listaSeguindo').innerHTML = 
                        seguindo.map(s => `
                            <div class="usuario-item">
                                <span>${s.nome}</span>
                                <button class="btn-seguir seguindo" onclick="deixarDeSeguir(${s.id_seguido})">
                                    Seguindo
                                </button>
                            </div>
                        `).join('');
                    
                    document.getElementById('modalPerfil').style.display = 'block';
                }
            } catch (error) {
                console.error('Erro ao carregar perfil:', error);
            }
        }

        async function seguirUsuario(idUsuario) {
            try {
                const response = await fetch('/seguir', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id_seguidor: usuarioLogado.id,
                        id_seguido: idUsuario,
                        nome_seguidor: usuarioLogado.nome
                    })
                });
                
                if (response.ok) {
                    alert('Usu√°rio seguido com sucesso!');
                    mostrarPerfil(); // Recarregar lista
                } else {
                    const error = await response.json();
                    alert(error.error);
                }
            } catch (error) {
                console.error('Erro ao seguir usu√°rio:', error);
            }
        }

        async function deixarDeSeguir(idUsuario) {
            try {
                const response = await fetch('/seguir', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id_seguidor: usuarioLogado.id,
                        id_seguido: idUsuario
                    })
                });
                
                if (response.ok) {
                    alert('Deixou de seguir o usu√°rio');
                    mostrarPerfil(); // Recarregar lista
                }
            } catch (error) {
                console.error('Erro ao deixar de seguir:', error);
            }
        }

        // ---------- CARREGAR POSTS DO BANCO ----------
        async function carregarPosts() {
            try {
                const response = await fetch('/posts');
                if (response.ok) {
                    const posts = await response.json();
                    const feed = document.querySelector('.feed');
                    
                    // Remove posts existentes (exceto o formul√°rio)
                    const postsExistentes = feed.querySelectorAll('.post');
                    postsExistentes.forEach(post => post.remove());
                    
                    // Adiciona posts do banco
                    posts.forEach(post => {
                        const postElement = document.createElement('div');
                        postElement.classList.add('post');
                        postElement.setAttribute('data-id', post.id);
                        postElement.innerHTML = `
                            <h3>${escapeHtml(post.autor_nome)}</h3>
                            <p>${escapeHtml(post.texto)}</p>
                            <div class="post-footer">
                                <button class="like-btn" aria-pressed="false">üëç Curtir <span class="like-count"></span></button>
                                <button class="comment-btn">üí¨ Comentar</button>
                            </div>
                            <div class="comment-section"></div>
                        `;
                        
                        // Insere ap√≥s o formul√°rio
                        const referencia = feed.children[2];
                        if (referencia) {
                            feed.insertBefore(postElement, referencia);
                        } else {
                            feed.appendChild(postElement);
                        }
                        
                        ativarComentarios(postElement);
                        ativarCurtidas(postElement);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar posts:', error);
            }
        }

        // Carregar posts quando a p√°gina carregar
        carregarPosts();
        
        // Carregar notifica√ß√µes quando a p√°gina carregar
        atualizarBadgeNotificacoes();

        // ---------- UTIL: gera√ß√£o de ID √∫nico para novos posts ----------
        function gerarIdPost() {
            return 'post-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
        }

        // ---------- COMENT√ÅRIOS ----------
        function ativarComentarios(post) {
            const commentBtn = post.querySelector('.comment-btn');

            commentBtn.addEventListener('click', () => {
                let commentSection = post.querySelector('.comment-section');

                // Evita duplicar o campo de coment√°rio
                if (post.querySelector('.comment-input')) return;

                const inputDiv = document.createElement('div');
                inputDiv.classList.add('comment-input');
                inputDiv.innerHTML = `
                    <input type="text" placeholder="Escreva um coment√°rio..." />
                    <button>Enviar</button>
                `;

                commentSection.appendChild(inputDiv);

                const input = inputDiv.querySelector('input');
                const sendBtn = inputDiv.querySelector('button');

                sendBtn.addEventListener('click', async () => {
                    const text = input.value.trim();
                    if (text !== "") {
                        const postId = post.getAttribute('data-id');
                        
                        try {
                            const response = await fetch('/comentarios', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    id_post: postId,
                                    id_usuario: usuarioLogado.id,
                                    texto: text,
                                    nome_usuario: usuarioLogado.nome
                                })
                            });

                            if (response.ok) {
                                const comment = document.createElement('div');
                                comment.classList.add('comment');
                                comment.textContent = `${usuarioLogado.nome}: ${text}`;
                                commentSection.insertBefore(comment, inputDiv);
                                input.value = "";
                            } else {
                                alert('Erro ao adicionar coment√°rio');
                            }
                        } catch (error) {
                            alert('Erro de conex√£o');
                        }
                    }
                });
            });
        }

        // ---------- CURTIDAS (conectado com banco de dados) ----------
        async function ativarCurtidas(post) {
            const likeBtn = post.querySelector('.like-btn');
            const countSpan = post.querySelector('.like-count');

            // garante que o post tem um id persistente
            let id = post.getAttribute('data-id');
            if (!id) {
                id = gerarIdPost();
                post.setAttribute('data-id', id);
            }

            // Carrega curtidas do banco
            async function carregarCurtidas() {
                try {
                    const response = await fetch(`/curtidas/${id}`);
                    if (response.ok) {
                        const data = await response.json();
                        countSpan.textContent = data.count > 0 ? `(${data.count})` : '';
                    }
                } catch (error) {
                    console.error('Erro ao carregar curtidas:', error);
                }
            }

            // atualiza UI
            function atualizarUI(liked) {
                likeBtn.style.color = liked ? "#0097e6" : "#333";
                likeBtn.setAttribute('aria-pressed', liked ? 'true' : 'false');
            }

            // click handler
            likeBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch('/curtidas', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            id_post: id,
                            id_usuario: usuarioLogado.id,
                            nome_usuario: usuarioLogado.nome
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        atualizarUI(data.liked);
                        await carregarCurtidas();
                    } else {
                        alert('Erro ao curtir post');
                    }
                } catch (error) {
                    alert('Erro de conex√£o');
                }
            });

            // Carrega curtidas iniciais
            await carregarCurtidas();
        }

        // ---------- Inicializa funcionalidades em posts existentes ----------
        document.querySelectorAll('.post').forEach(post => {
            // se algum post inicial n√£o tiver data-id, garante um
            if (!post.getAttribute('data-id')) {
                post.setAttribute('data-id', gerarIdPost());
            }
            ativarComentarios(post);
            ativarCurtidas(post);
        });

        // ---------- NOVA POSTAGEM ----------
        const novaPostagemBtn = document.getElementById('novaPostagemBtn');
        const formNovaPostagem = document.getElementById('formNovaPostagem');
        const enviarPost = document.getElementById('enviarPost');
        const feed = document.querySelector('.feed');

        novaPostagemBtn.addEventListener('click', () => {
            formNovaPostagem.classList.toggle('oculto');
            const textarea = document.getElementById('textoPost');
            if (!formNovaPostagem.classList.contains('oculto')) {
                textarea.focus();
            }
        });

        enviarPost.addEventListener('click', async () => {
            const texto = document.getElementById('textoPost').value.trim();

            if (texto === "") {
                alert("Preencha o campo de texto!");
                return;
            }

            try {
                const response = await fetch('/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id_usuario: usuarioLogado.id,
                        texto: texto
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    const novoPost = document.createElement('div');
                    novoPost.classList.add('post');
                    novoPost.setAttribute('data-id', data.id);
                    novoPost.innerHTML = `
                        <h3>${escapeHtml(usuarioLogado.nome)}</h3>
                        <p>${escapeHtml(texto)}</p>
                        <div class="post-footer">
                            <button class="like-btn" aria-pressed="false">üëç Curtir <span class="like-count"></span></button>
                            <button class="comment-btn">üí¨ Comentar</button>
                        </div>
                        <div class="comment-section"></div>
                    `;

                    // Insere no feed (logo abaixo do formul√°rio)
                    const referencia = feed.children[2];
                    if (referencia) {
                        feed.insertBefore(novoPost, referencia);
                    } else {
                        feed.appendChild(novoPost);
                    }

                    ativarComentarios(novoPost);
                    ativarCurtidas(novoPost);

                    document.getElementById('textoPost').value = "";
                    formNovaPostagem.classList.add('oculto');
                } else {
                    alert('Erro ao criar post');
                }
            } catch (error) {
                alert('Erro de conex√£o');
            }
        });

        // Fun√ß√£o simples para escapar HTML (evita XSS b√°sico em exemplo)
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // ---------- UPLOAD E ARMAZENAMENTO DA FOTO DE PERFIL ----------
        const uploadFoto = document.getElementById('uploadFoto');
        const fotoPerfil = document.getElementById('fotoPerfil');
        const btnResetFoto = document.getElementById('btnResetFoto');

        // Carrega imagem guardada (se existir)
        const fotoSalva = localStorage.getItem('fotoPerfil');
        if (fotoSalva) {
            fotoPerfil.src = fotoSalva;
        }

        uploadFoto.addEventListener('change', function () {
            const file = this.files[0];
            if (!file) return;

            // limite simples (ex.: 3MB)
            const maxSize = 3 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('Imagem muito grande. Limite: 3MB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                fotoPerfil.src = e.target.result;
                try {
                    localStorage.setItem('fotoPerfil', e.target.result);
                } catch (err) {
                    // localStorage pode falhar se a imagem for muito grande
                    console.warn('N√£o foi poss√≠vel salvar a imagem no localStorage:', err);
                }
            };
            reader.readAsDataURL(file);
        });

        btnResetFoto.addEventListener('click', () => {
            localStorage.removeItem('fotoPerfil');
            fotoPerfil.src = 'https://via.placeholder.com/100';
        });

        // ---------- Op√ß√£o: Atualizar nome do usu√°rio via bot√£o Editar Perfil (simples modal) ----------
        const btnEditarPerfil = document.getElementById('btnEditarPerfil');
        const nomeUsuario = document.getElementById('nomeUsuario');

        // carrega dados do usu√°rio logado
        nomeUsuario.textContent = usuarioLogado.nome;

        btnEditarPerfil.addEventListener('click', () => {
            const novoNome = prompt('Digite seu nome:', nomeUsuario.textContent || '');
            if (novoNome !== null) {
                const nomeTrim = novoNome.trim();
                if (nomeTrim.length > 0) {
                    nomeUsuario.textContent = nomeTrim;
                    // Atualizar no localStorage e backend
                    usuarioLogado.nome = nomeTrim;
                    localStorage.setItem('usuario', JSON.stringify(usuarioLogado));
                    
                    // Atualizar no backend
                    fetch(`/usuarios/${usuarioLogado.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            nome: nomeTrim,
                            email: usuarioLogado.email,
                            senha: '' // N√£o enviar senha vazia
                        })
                    });
                } else {
                    alert('Nome vazio n√£o √© v√°lido.');
                }
            }
        });

        // ---------- deletar usu√°rio ----------

        async function deleteUser() {
            const confirmDelete = confirm('Tem certeza que deseja deletar sua conta? Esta a√ß√£o √© irrevers√≠vel.');
            if (!confirmDelete) return;

            try {
                const response = await fetch(`/usuarios/${usuarioLogado.id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Conta deletada com sucesso.');
                    logout();
                } else {
                    alert('Erro ao deletar conta.');
                }
            } catch (error) {
                alert('Erro de conex√£o.');
            }
        }

    </script>
</body>
</html>
